<?xml version="1.0"?>
<!DOCTYPE project>
<project name="appserver-io-php/runtime" default="build" basedir=".">

    <!-- ==================================================================== -->
    <!-- Load the environment variables into our properties                   -->
    <!-- ==================================================================== -->
    <property environment="env" />
    
    <!-- ==================================================================== -->
    <!-- Generate a time stamp for further use in build targets               -->
    <!-- ==================================================================== --> 
    <tstamp>
        <format property="time.stamp" pattern="yyyy-MM-dd_HHmmss"/>
    </tstamp>

    <!-- ==================================================================== -->
    <!-- Create some basic properties which we need for further processing    -->
    <!-- The property hub.scp-user is missing on purpose and has to be        -->
    <!-- provided within the build environment                                -->
    <!-- ==================================================================== -->
    <property name="hub.address" value="bernade.appserver.io"/>
    <property name="lib.dir" value="${basedir}/lib" />
    <property name="src.dir" value="${basedir}/src" />
    <property name="target.dir" value="${basedir}/target"/>
    <property name="php-test.dir" value="${basedir}/tests" />
    <property name="build.dir" value="${basedir}/build" />
    <property name="temp.dir" value="${basedir}/tmp" />
    <property name="reports.dir" value="${basedir}/reports" />

    <!-- ==================================================================== -->
    <!-- Load all property files in the right order                           -->
    <!-- ==================================================================== -->
    <property file="${basedir}/build.properties"/>
    <property file="${user.home}/build.properties"/>
    <property file="${basedir}/build.default.properties"/>

    <!-- ==================================================================== -->
    <!-- Import the build.xml files, defined by os.family property            -->
    <!-- ==================================================================== -->
    <import file="buildfiles/${os.family}/build.xml"/>

    <!-- ==================================================================== -->
    <!-- Remote path to recently built resources                              -->
    <!-- ==================================================================== -->
    <property name="hub.snapshot-path" value="/var/www/builds.appserver.io/${os.qualified.path}"/>
	
    <!-- ==================================================================== -->
    <!-- Cleans the directories with the generated source files               -->
    <!-- ==================================================================== -->
    <target name="clean" description="Cleans build directory in preparation for new build.">
        <delete dir="${target.dir}" includeemptydirs="true" quiet="false" verbose="true" failonerror="true"/>
        <delete dir="${temp.dir}" includeemptydirs="true" quiet="false" verbose="true" failonerror="true"/>
    </target>

    <!-- ==================================================================== -->
    <!-- Cleans the build directories                                         -->
    <!-- ==================================================================== -->
    <target name="clean-build"  depends="prepare-build">
        <delete includeemptydirs="true" quiet="false" verbose="false" failonerror="true">
            <fileset dir="${build.dir}" includes="**/*"/>
        </delete>
    </target>

    <!-- ==================================================================== -->
    <!-- Cleans the reports directories                                       -->
    <!-- ==================================================================== -->
    <target name="clean-reports"  depends="prepare-reports">
        <delete includeemptydirs="true" quiet="false" verbose="false" failonerror="true">
            <fileset dir="${reports.dir}" includes="**/*"/>
        </delete>
    </target>

    <!-- ==================================================================== -->
    <!-- Prepares the reports environment                                     -->
    <!-- ==================================================================== -->
    <target name="prepare-reports">
        <mkdir dir="${reports.dir}" />
    </target>

    <!-- ==================================================================== -->
    <!-- Prepares the build environment                                       -->
    <!-- ==================================================================== -->
    <target name="prepare-build">
        <mkdir dir="${build.dir}" />
    </target>

    <!-- ==================================================================== -->
    <!-- Copies any built package to the snapshot hosting server.             -->
    <!-- ==================================================================== -->
    <target name="copy-to-hub" depends="prepare-package-name" description="Copies any built package to the snapshot hosting server.">
        <echo message="Now trying to upload ${package.name} to snapshot server"/>
        <scp file="${build.dir}/${package.name}" todir="${hub.scp-user}@${hub.address}:${hub.snapshot-path}" keyfile="${user.home}/.ssh/id_rsa" failonerror="true" />
    </target>

    <!-- ==================================================================== -->
    <!-- Prepares all the required directories                                -->
    <!-- ==================================================================== -->
    <target name="prepare" depends="clean" description="Prepares all the required directories.">
        <mkdir dir="${target.dir}" />
        <mkdir dir="${lib.dir}" />
        <mkdir dir="${temp.dir}" />
    </target>

    <!-- ==================================================================== -->
    <!-- Copies the sources to the temporary directory                        -->
    <!-- ==================================================================== -->
    <target name="copy" depends="prepare" description="Copies the sources to the target directory.">
        <copy todir="${target.dir}" preservelastmodified="true" overwrite="true">
            <fileset dir="${src.dir}/${os.family}/generic">
                <include name="**/*" />
            </fileset>
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
        <copy todir="${target.dir}" failonerror="false" preservelastmodified="true" overwrite="true">
            <fileset dir="${src.dir}/${os.family}/${os.distribution}">
                <include name="**/*" />
            </fileset>
        </copy>
    </target>

    <!-- ==================================================================== -->
    <!-- Copies the sources to the deploy directory                           -->
    <!-- ==================================================================== -->
    <target name="deploy" depends="copy" description="Copies the sources to the deploy directory.">
        <copy todir="${dir.www}/${deploy.dir}" preservelastmodified="true" overwrite="true">
            <fileset dir="${target.dir}">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>

    <!-- ==================================================================== -->
    <!-- Will test if the targeted box is already started                     -->
    <!-- ==================================================================== -->
    <target name="test-vagrant-box-started">
        <!-- issue the actual command -->
        <exec dir="${temp.dir}" executable="vagrant" errorproperty="vagrant.box.not-started">
            <arg line="ssh ${vagrant-box.name}" />
        </exec>
    </target>

    <!-- ==================================================================== -->
    <!-- Will test if a readily packaged vagrant machine is available at the  -->
    <!-- appropriate location. Only makes sense if the box name is known      -->
    <!-- ==================================================================== -->
    <target name="test-packaged-box-exists" if="vagrant-box.name">
        <available file="${http://boxes.appserver.io/linux/fedora}/${vagrant-box.name}" property="vagrant.packaged-box.exists"/>
    </target>

    <!-- ==================================================================== -->
    <!-- Will initialize an already packaged vagrant box                      -->
    <!-- ==================================================================== -->
    <target name="initialize-packaged-box" depends="test-packaged-box-exists" if="vagrant.packaged-box.exists">
        <!-- issue the actual start command -->
        <exec dir="${temp.dir}" executable="vagrant" failonerror="true">
            <arg line="up ${vagrant-box.name} --provider=${vagrant.provider}" />
        </exec>
    </target>

    <!-- ==================================================================== -->
    <!-- Will start a vagrant box within the tmp directory                    -->
    <!-- ==================================================================== -->
    <target name="start-vagrant-box" depends="test-vagrant-box-started, initialize-packaged-box" if="vagrant.box.not-started">
        <!-- issue the actual start command -->
        <exec dir="${temp.dir}" executable="vagrant" errorproperty="vagrant-box.start.failed">
            <arg line="up ${vagrant-box.name} --provider=${vagrant.provider}" />
        </exec>
        <!-- make sure the box gets destroyed if there have been errors during startup -->
        <antcall target="destroy-vagrant-box-on-error" />
    </target>

    <!-- ==================================================================== -->
    <!-- Will start a vagrant box specifically suited for build tasks         -->
    <!-- ==================================================================== -->
    <target name="start-vagrant-build-box">
        <!-- map the vagrant name according to our prepared environment -->
        <property name="vagrant-box.name" value="${vagrant-box.prefix}Build" />
        <!-- prepare the building environment -->
        <antcall target="prepare-build-environment" />
        <!-- start our vagrant box -->
        <antcall target="start-vagrant-box" />
    </target>

    <!-- ==================================================================== -->
    <!-- Will destroy any running vagrant box within our tmp directory        -->
    <!-- ==================================================================== -->
    <target name="destroy-vagrant-box">
        <!-- issue the actual destroy command -->
        <exec dir="${temp.dir}" executable="vagrant" failonerror="true">
            <arg line="destroy -f" />
        </exec>
    </target>

    <!-- ==================================================================== -->
    <!-- Will destroy any running vagrant box within our tmp directory if     -->
    <!-- a "fatal" error occured previously                                   -->
    <!-- ==================================================================== -->
    <target name="destroy-vagrant-box-on-error" if="vagrant-box.start.failed">
        <!-- issue the actual destroy call -->
        <antcall target="destroy-vagrant-box" />
    </target>

    <!-- ==================================================================== -->
    <!-- Will prepare the environment to run a vagrant box in                 -->
    <!-- ==================================================================== -->
    <target name="prepare-build-environment" depends="prepare, clean-build, clean-reports">
        <copy todir="${temp.dir}" failonerror="true">
            <fileset dir="${basedir}">
               <include name="build.*"/>
               <include name="buildfiles/**"/>
            </fileset>
        </copy>
        <!-- expand the properties within our box configuration -->
        <copy todir="${temp.dir}" failonerror="true">
            <fileset dir="${basedir}/buildfiles/${os.family}">
                <include name="Vagrantfile"/>
            </fileset>
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
        <!-- prepare a tmp dir for work within the VM -->
        <mkdir dir="${temp.dir}/tmp" />
    </target>

    <!-- ==================================================================== -->
    <!-- Builds the runtime within a temporarily started vagrant box.         -->
    <!-- Box will be started and destroyed automatically                      -->
    <!-- ==================================================================== -->
    <target name="build">
        <!-- start our vagrant box -->
        <antcall target="start-vagrant-build-box" />
        <!-- start the build in the box -->
        <antcall target="vagrant-build" />
        <!-- destroy the box after all work is done -->
        <antcall target="destroy-vagrant-box" />
        <!-- tell them about any failures we might encountered -->
        <fail if="build.failed" message="The build failed with message '${build.failed}', see log above." />
    </target>

    <!-- ==================================================================== -->
    <!-- Builds the runtime within an existing vagrant box                    -->
    <!-- ==================================================================== -->
    <target name="vagrant-build">
        <!-- invoke original build target within vagrant box -->
        <exec dir="${temp.dir}" executable="vagrant" errorproperty="build.failed">
            <arg line="ssh -c 'sudo ant build -buildfile ${vagrant.basedir}/build.xml -Dbuild.number=${build.number} -Dtarget-os.version=${target-os.version} -Dos.family=${os.family} -Dos.distribution=${os.distribution}'" />
        </exec>
    </target>

    <!-- ==================================================================== -->
    <!-- Builds the runtime locally without the use of vagrant                -->
    <!-- ==================================================================== -->
    <target name="local-build" depends="prepare-build" description="Builds the runtime and creates a .tgz package.">
        <!-- do the actual building -->
        <antcall target="build-runtime" />
        <!-- create a compressed package of the recent build -->
        <antcall target="create-package" />
    </target>

</project>
